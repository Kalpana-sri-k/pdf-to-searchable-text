# app/ingest_with_embeddings.py
from app.ingest import ingest_pdf_json
from app.chunker import chunk_text
from app.embedder import embed_chunks

def ingest_pdf_with_embeddings(pdf_path):
    data = ingest_pdf_json(pdf_path)

    all_chunks = []
    metadata = []

    for page in data['pages']:
        for block in page['blocks']:
            text = block['text']
            chunks = chunk_text(text)
            for c in chunks:
                all_chunks.append(c)
                metadata.append({
                    "page": page['page_num'],
                    "bbox": block['bbox'],
                    "text": c
                })

    embeddings = embed_chunks(all_chunks)

    # Return structured data for your vector DB (Milvus, Weaviate, Pinecone)
    return [{"embedding": e, "meta": m} for e, m in zip(embeddings, metadata)]
